-- Services
local CoreGui = game:GetService("CoreGui")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")

-- Variables to store GUI elements
local sanityGui, window

-- Function to create and show the GUI
function createGUI()
    -- Load the external GUI script
    local a = loadstring(game:HttpGet("https://raw.githubusercontent.com/DashaBars/Hack/main/Gui"))()
    window = a:Window("Specter")
    window.Position = UDim2.new(1, -300, 0, 10)  -- Adjust position as needed

    -- Create GUI for Sanity Check
    sanityGui = Instance.new("ScreenGui")
    local sanityLabel = Instance.new("TextLabel")
    local teleportButton = Instance.new("TextButton")
    local teleportToBoneButton = Instance.new("TextButton")
    local startButton = Instance.new("TextButton")

    sanityGui.Name = "SanityCheckGui"
    sanityGui.Parent = CoreGui

    sanityLabel.Name = "SanityLabel"
    sanityLabel.Parent = sanityGui
    sanityLabel.BackgroundTransparency = 0.5
    sanityLabel.Position = UDim2.new(1, -150, 0, 10)
    sanityLabel.Size = UDim2.new(0, 140, 0, 30)
    sanityLabel.Font = Enum.Font.SourceSansBold
    sanityLabel.TextSize = 20
    sanityLabel.TextColor3 = Color3.fromRGB(70, 130, 180)
    sanityLabel.TextStrokeTransparency = 0
    sanityLabel.Text = "Sanity: Loading..."

    teleportButton.Name = "TeleportButton"
    teleportButton.Parent = sanityGui
    teleportButton.AnchorPoint = Vector2.new(1, 0)
    teleportButton.Position = UDim2.new(1, -150, 0, 50)
    teleportButton.Size = UDim2.new(0, 140, 0, 30)
    teleportButton.Font = Enum.Font.SourceSansBold
    teleportButton.TextSize = 18
    teleportButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    teleportButton.BackgroundColor3 = Color3.fromRGB(0, 128, 255)
    teleportButton.BackgroundTransparency = 0.7
    teleportButton.TextStrokeTransparency = 0
    teleportButton.Text = "To Van"
    teleportButton.MouseButton1Click:Connect(function()
        HumanoidRootPart.CFrame = Workspace.Van.Spawn.CFrame + Vector3.new(0, 3, 0)
    end)

    teleportToBoneButton.Name = "TeleportToBoneButton"
    teleportToBoneButton.Parent = sanityGui
    teleportToBoneButton.AnchorPoint = Vector2.new(1, 0)
    teleportToBoneButton.Position = UDim2.new(1, -150, 0, 90)
    teleportToBoneButton.Size = UDim2.new(0, 140, 0, 30)
    teleportToBoneButton.Font = Enum.Font.SourceSansBold
    teleportToBoneButton.TextSize = 18
    teleportToBoneButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    teleportToBoneButton.BackgroundColor3 = Color3.fromRGB(0, 128, 255)
    teleportToBoneButton.BackgroundTransparency = 0.7
    teleportToBoneButton.TextStrokeTransparency = 0
    teleportToBoneButton.Text = "To Bone"
    teleportToBoneButton.MouseButton1Click:Connect(function()
        HumanoidRootPart.CFrame = Workspace.House.Bone.CFrame + Vector3.new(0, 2, 0)
    end)

    startButton.Name = "StartButton"
    startButton.Parent = sanityGui
    startButton.AnchorPoint = Vector2.new(0, 0.5)
    startButton.Position = UDim2.new(1, -150, 0, 130)
    startButton.Size = UDim2.new(0, 140, 0, 30)
    startButton.Font = Enum.Font.SourceSansBold
    startButton.TextSize = 18
    startButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    startButton.BackgroundColor3 = Color3.fromRGB(0, 128, 255)
    startButton.BackgroundTransparency = 0.7
    startButton.TextStrokeTransparency = 0
    startButton.Text = "Start"
    startButton.MouseButton1Click:Connect(function()
        ReplicatedStorage:WaitForChild("Start"):FireServer()
    end)

    RunService.RenderStepped:Connect(function()
        local sanity = LocalPlayer.Data:FindFirstChild("Sanity")
        if sanity then
            sanityLabel.Text = "Sanity: " .. tostring(math.floor(sanity.Value))
        end
    end)
end

-- Function to unload the GUI
function unloadGUI()
    if sanityGui then
        sanityGui:Destroy()
        sanityGui = nil
    end

    if window then
        window:Destroy()
        window = nil
    end

    -- Force garbage collection
    collectgarbage("collect")
end

-- Function to load and execute the script
function loadAndExecuteScript()
    -- Unload the current GUI
    unloadGUI()

    -- Create and show the GUI
    createGUI()

    -- Additional setup if needed
    -- Protect GUI
    if not pcall(function() return syn.protect_gui end) then
        syn = {}
        syn.protect_gui = function(gui) gui.Parent = CoreGui end
    end

    -- Setup
    Workspace.FallenPartsDestroyHeight = -50000
    Lighting.Brightness = 2
    Lighting.GlobalShadows = false
    Lighting.OutdoorAmbient = Color3.fromRGB(128, 128, 128)
    Lighting.Ambient = Color3.fromRGB(128, 128, 128)
    Lighting.FogEnd = 100000

    for _, descendant in pairs(Lighting:GetDescendants()) do
        if descendant:IsA("Atmosphere") then
            descendant:Destroy()
        end
    end

    -- Create and handle billboard GUI
    local function createBillboardGui(adornedPart, text, color)
        local billboardGui = Instance.new("BillboardGui")
        local textLabel = Instance.new("TextLabel")

        billboardGui.Adornee = adornedPart
        billboardGui.Size = UDim2.new(0, 100, 0, 150)
        billboardGui.StudsOffset = Vector3.new(0, 1, 0)
        billboardGui.AlwaysOnTop = true

        textLabel.Parent = billboardGui
        textLabel.BackgroundTransparency = 1
        textLabel.Position = UDim2.new(0, 0, 0, -50)
        textLabel.Size = UDim2.new(0, 100, 0, 100)
        textLabel.Font = Enum.Font.SourceSansSemibold
        textLabel.TextSize = 14
        textLabel.TextColor3 = color
        textLabel.TextStrokeTransparency = 0
        textLabel.TextYAlignment = Enum.TextYAlignment.Bottom
        textLabel.Text = text
        textLabel.ZIndex = 10

        return billboardGui
    end

    local function addBillboardGuiToPart(name, text, color)
        for _, part in pairs(Workspace:GetChildren()) do
            if part.Name == name then
                local billboardGui = createBillboardGui(part, text, color)
                billboardGui.Parent = part
            end
        end

        Workspace.ChildAdded:Connect(function(child)
            if child.Name == name then
                local billboardGui = createBillboardGui(child, text, color)
                billboardGui.Parent = child
            end
        end)
    end

    addBillboardGuiToPart("Orb", "Orb", Color3.fromRGB(30, 144, 255))
    addBillboardGuiToPart("emfpart5", "Emf5", Color3.fromRGB(255, 0, 0))
    addBillboardGuiToPart("emfpart3", "Emf3", Color3.fromRGB(100, 140, 0))
    addBillboardGuiToPart("emfpart4", "Emf4", Color3.fromRGB(100, 69, 0))
    addBillboardGuiToPart("FuseBox", "FuseBox", Color3.fromRGB(192, 192, 192))
    addBillboardGuiToPart("Van", "Van", Color3.fromRGB(255, 0, 255))
    addBillboardGuiToPart("BoneModel", "Bone", Color3.fromRGB(230, 230, 250))
    addBillboardGuiToPart("Door", "Exit", Color3.fromRGB(0, 128, 0))

    for _, ghost in pairs(Workspace:GetChildren()) do
        if ghost.Name == "GhostModel" and ghost:FindFirstChild("Humanoid") then
            local boxAdornment = Instance.new("BoxHandleAdornment")
            boxAdornment.Adornee = ghost.HumanoidRootPart
            boxAdornment.AlwaysOnTop = true
            boxAdornment.Color3 = Color3.fromRGB(255, 250, 250)
            boxAdornment.Size = Vector3.new(2, 2, 1)
            boxAdornment.Transparency = 0.5
            boxAdornment.ZIndex = 2
            boxAdornment.Parent = ghost
            boxAdornment.Name = "ESP"

            local ghostGui = createBillboardGui(ghost.HumanoidRootPart, "Ghost Name: " .. Workspace:FindFirstChild("Van").Objectives.SurfaceGui.Frame.Objectives.GhostInfo.Text:split("is ")[2]:match(">(.+)<"), Color3.new(1, 1, 1))
            ghostGui.Parent = ghost
        end
    end

    local camera = Workspace.CurrentCamera
    local function esp(player, character)
        local humanoid = character:WaitForChild("Humanoid")
        local head = character:WaitForChild("Head")

        local text = Drawing.new("Text")
        text.Visible = false
        text.Center = true
        text.Outline = false
        text.Font = 3
        text.Size = 16.16
        text.Color = Color3.new(170, 170, 170)

        local connection
        local connection2
        local connection3

        local function disconnect()
            text.Visible = false
            text:Remove()
            if connection then connection:Disconnect() connection = nil end
            if connection2 then connection2:Disconnect() connection2 = nil end
            if connection3 then connection3:Disconnect() connection3 = nil end
        end

        connection2 = character.AncestryChanged:Connect(function(_, parent)
            if not parent then
                disconnect()
            end
        end)

        connection3 = humanoid.HealthChanged:Connect(function(value)
            if value <= 0 or humanoid:GetState() == Enum.HumanoidStateType.Dead then
                disconnect()
            end
        end)

        connection = RunService.RenderStepped:Connect(function()
            local headPos, onScreen = camera:WorldToViewportPoint(head.Position)
            if onScreen then
                text.Position = Vector2.new(headPos.X, headPos.Y - 27)
                text.Text = "[ " .. player.Name .. " ]"
                text.Visible = true
            else
                text.Visible = false
            end
            wait(0.073)
        end)
    end

    local function playerAdded(player)
        if player.Character then
            esp(player, player.Character)
        end
        player.CharacterAdded:Connect(function(character)
            esp(player, character)
        end)
    end

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            playerAdded(player)
        end
    end

    Players.PlayerAdded:Connect(playerAdded)
    ReplicatedStorage:WaitForChild("Start"):FireServer()

    while true do
        LocalPlayer.Character.Humanoid.WalkSpeed = 10
        wait(0.5)
    end
end

-- Execute the script loading function
loadAndExecuteScript()
