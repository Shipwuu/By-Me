-- Services
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local flyGui = Instance.new("ScreenGui")
flyGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local FLYING = false
local iyflyspeed = 50
local velocityHandlerName = "FlyVelocity"
local gyroHandlerName = "FlyGyro"
local mobileFlyConnection

-- Create Toggle Button
local toggleButton = Instance.new("TextButton")
toggleButton.Name = "ToggleFlyButton"
toggleButton.Parent = flyGui
toggleButton.AnchorPoint = Vector2.new(0, 0.5)
toggleButton.Position = UDim2.new(1, -200, 0, 200) -- Adjust position as needed
toggleButton.Size = UDim2.new(0, 140, 0, 30)
toggleButton.Font = Enum.Font.SourceSansBold
toggleButton.TextSize = 18
toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleButton.BackgroundColor3 = Color3.fromRGB(0, 128, 255)
toggleButton.BackgroundTransparency = 0.7
toggleButton.TextStrokeTransparency = 0
toggleButton.Text = "Toggle Fly"

-- Utility Functions
local function getRoot(char)
    return char:FindFirstChild("HumanoidRootPart") or char:FindFirstChildWhichIsA("BasePart")
end

local function startFlying()
    FLYING = true
    local character = LocalPlayer.Character
    local root = getRoot(character)

    -- Create BodyVelocity and BodyGyro
    local bv = Instance.new("BodyVelocity")
    bv.Name = velocityHandlerName
    bv.Parent = root
    bv.MaxForce = Vector3.new(9e9, 9e9, 9e9)
    bv.Velocity = Vector3.new(0, 0, 0)

    local bg = Instance.new("BodyGyro")
    bg.Name = gyroHandlerName
    bg.Parent = root
    bg.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
    bg.P = 1000
    bg.D = 50

    -- Mobile Fly Control
    mobileFlyConnection = RunService.RenderStepped:Connect(function()
        local moveDirection = Vector3.new(UserInputService:GetDeviceAcceleration().x, UserInputService:GetDeviceAcceleration().y, UserInputService:GetDeviceAcceleration().z).Unit * iyflyspeed
        bv.Velocity = moveDirection
        bg.CFrame = workspace.CurrentCamera.CFrame
    end)
end

local function stopFlying()
    FLYING = false
    local character = LocalPlayer.Character
    local root = getRoot(character)

    -- Destroy BodyVelocity and BodyGyro
    if root:FindFirstChild(velocityHandlerName) then
        root:FindFirstChild(velocityHandlerName):Destroy()
    end
    if root:FindFirstChild(gyroHandlerName) then
        root:FindFirstChild(gyroHandlerName):Destroy()
    end

    if mobileFlyConnection then
        mobileFlyConnection:Disconnect()
    end
end

-- Toggle Fly Functionality
toggleButton.MouseButton1Click:Connect(function()
    if FLYING then
        stopFlying()
        toggleButton.Text = "Start Fly"
    else
        startFlying()
        toggleButton.Text = "Stop Fly"
    end
end)
