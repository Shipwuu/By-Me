-- LocalScript in StarterPlayerScripts or StarterGui

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

-- Wait until the player is in the game
repeat wait() until Players.LocalPlayer and Players.LocalPlayer.Character and Players.LocalPlayer.Character:FindFirstChild("Humanoid") and Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")

local player = Players.LocalPlayer
local character = player.Character
local humanoid = character:WaitForChild("Humanoid")
local rootPart = character:WaitForChild("HumanoidRootPart")
local mouse = player:GetMouse()

-- Variables
local flying = false
local speed = 50
local bodyGyro, bodyVelocity
local ctrl = {f = 0, b = 0, l = 0, r = 0}
local lastCtrl = {f = 0, b = 0, l = 0, r = 0}

-- Function to start flying
local function startFlying()
    if flying then return end
    
    bodyGyro = Instance.new("BodyGyro")
    bodyGyro.P = 9e4
    bodyGyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
    bodyGyro.CFrame = rootPart.CFrame
    bodyGyro.Parent = rootPart

    bodyVelocity = Instance.new("BodyVelocity")
    bodyVelocity.Velocity = Vector3.new(0, 0, 0)
    bodyVelocity.MaxForce = Vector3.new(9e9, 9e9, 9e9)
    bodyVelocity.Parent = rootPart

    flying = true
    humanoid.PlatformStand = true

    -- Update loop for flying
    RunService.RenderStepped:Connect(function()
        if flying then
            local moveDirection = Vector3.new()
            local lookVector = workspace.CurrentCamera.CFrame.LookVector
            local rightVector = workspace.CurrentCamera.CFrame.RightVector

            if ctrl.f ~= 0 or ctrl.b ~= 0 then
                speed = math.min(speed + 0.5 + (speed / 50), 50)
            elseif speed ~= 0 then
                speed = math.max(speed - 1, 0)
            end

            if ctrl.f ~= 0 or ctrl.b ~= 0 then
                bodyVelocity.Velocity = ((lookVector * (ctrl.f + ctrl.b)) + ((workspace.CurrentCamera.CFrame * CFrame.new(ctrl.l + ctrl.r, (ctrl.f + ctrl.b) * 0.2, 0).p) - workspace.CurrentCamera.CFrame.p)) * speed
                lastCtrl = {f = ctrl.f, b = ctrl.b, l = ctrl.l, r = ctrl.r}
            elseif ctrl.l == 0 and ctrl.r == 0 and ctrl.f == 0 and ctrl.b == 0 and speed ~= 0 then
                bodyVelocity.Velocity = ((lookVector * (lastCtrl.f + lastCtrl.b)) + ((workspace.CurrentCamera.CFrame * CFrame.new(lastCtrl.l + lastCtrl.r, (lastCtrl.f + lastCtrl.b) * 0.2, 0).p) - workspace.CurrentCamera.CFrame.p)) * speed
            else
                bodyVelocity.Velocity = Vector3.new(0, 0, 0)
            end

            bodyGyro.CFrame = workspace.CurrentCamera.CFrame * CFrame.Angles(-math.rad((ctrl.f + ctrl.b) * 50 * speed / 50), 0, 0)
        end
    end)
end

-- Function to stop flying
local function stopFlying()
    if bodyGyro then bodyGyro:Destroy() end
    if bodyVelocity then bodyVelocity:Destroy() end

    humanoid.PlatformStand = false
    flying = false
end

-- Toggle flying on and off
local function toggleFlying()
    if flying then
        stopFlying()
    else
        startFlying()
    end
end

-- Create the UI button to toggle flying
local function createToggleButton()
    local screenGui = Instance.new("ScreenGui", player.PlayerGui)
    local button = Instance.new("TextButton", screenGui)
    button.Size = UDim2.new(0, 200, 0, 50)
    button.Position = UDim2.new(0.5, -100, 0.9, -25)
    button.Text = "Toggle Fly"
    button.BackgroundColor3 = Color3.fromRGB(0, 0, 255)
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.TextScaled = true
    button.BorderSizePixel = 0

    button.MouseButton1Click:Connect(toggleFlying)
end

-- Handle keyboard input for flying controls
local function setupControls()
    mouse.KeyDown:Connect(function(key)
        if key:lower() == "e" then
            toggleFlying()
        elseif key:lower() == "w" then
            ctrl.f = 1
        elseif key:lower() == "s" then
            ctrl.b = -1
        elseif key:lower() == "a" then
            ctrl.l = -1
        elseif key:lower() == "d" then
            ctrl.r = 1
        end
    end)

    mouse.KeyUp:Connect(function(key)
        if key:lower() == "w" then
            ctrl.f = 0
        elseif key:lower() == "s" then
            ctrl.b = 0
        elseif key:lower() == "a" then
            ctrl.l = 0
        elseif key:lower() == "d" then
            ctrl.r = 0
        end
    end)
end

createToggleButton()
setupControls()
