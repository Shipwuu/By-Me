-- LocalScript in StarterPlayerScripts or StarterGui

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local rootPart = character:WaitForChild("HumanoidRootPart")

local flying = false
local speed = 50
local bodyGyro, bodyVelocity
local CONTROL = {F = 0, B = 0, L = 0, R = 0, Q = 0, E = 0}
local lCONTROL = {F = 0, B = 0, L = 0, R = 0, Q = 0, E = 0}
local QEfly = true
local flyKeyDown, flyKeyUp

-- Function to start flying
local function startFlying()
    if flying then return end

    bodyGyro = Instance.new("BodyGyro")
    bodyGyro.P = 9e4
    bodyGyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
    bodyGyro.CFrame = rootPart.CFrame
    bodyGyro.Parent = rootPart

    bodyVelocity = Instance.new("BodyVelocity")
    bodyVelocity.Velocity = Vector3.new(0, 0, 0)
    bodyVelocity.MaxForce = Vector3.new(9e9, 9e9, 9e9)
    bodyVelocity.Parent = rootPart

    flying = true
    humanoid.PlatformStand = true

    -- Update loop for flying
    RunService.RenderStepped:Connect(function()
        if flying then
            local moveDirection = Vector3.new()

            -- Handle desktop controls
            local moveVector = Vector3.zero
            if UserInputService:IsKeyDown(Enum.KeyCode.W) then
                moveVector = moveVector + workspace.CurrentCamera.CFrame.LookVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.S) then
                moveVector = moveVector - workspace.CurrentCamera.CFrame.LookVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.A) then
                moveVector = moveVector - workspace.CurrentCamera.CFrame.RightVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.D) then
                moveVector = moveVector + workspace.CurrentCamera.CFrame.RightVector
            end
            moveDirection = Vector3.new(moveVector.X, 0, moveVector.Z)

            -- Update body velocity based on input
            if moveDirection.Magnitude > 0 then
                bodyVelocity.Velocity = moveDirection.Unit * speed
            else
                bodyVelocity.Velocity = Vector3.new(0, bodyVelocity.Velocity.Y, 0) -- Maintain Y velocity
            end

            -- Keep the character aligned with the camera
            bodyGyro.CFrame = workspace.CurrentCamera.CFrame
        end
    end)
end

-- Function to stop flying
local function stopFlying()
    if bodyGyro then bodyGyro:Destroy() end
    if bodyVelocity then bodyVelocity:Destroy() end

    humanoid.PlatformStand = false
    flying = false
end

-- Function to toggle flying mode
local function toggleFlying()
    if flying then
        stopFlying()
    else
        startFlying()
    end
end

-- Function to create the UI button
local function createToggleButton()
    local screenGui = Instance.new("ScreenGui", player.PlayerGui)
    local button = Instance.new("TextButton", screenGui)
    button.Size = UDim2.new(0, 200, 0, 50)
    button.Position = UDim2.new(0.5, -100, 0.9, -25)
    button.Text = "Toggle Fly"
    button.BackgroundColor3 = Color3.fromRGB(0, 0, 255)
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.TextScaled = true
    button.BorderSizePixel = 0

    button.MouseButton1Click:Connect(toggleFlying)
end

-- Function to handle key input for flying controls
local function setupControls()
    flyKeyDown = UserInputService.InputBegan:Connect(function(input)
        if flying then
            if input.KeyCode == Enum.KeyCode.W then
                CONTROL.F = speed
            elseif input.KeyCode == Enum.KeyCode.S then
                CONTROL.B = -speed
            elseif input.KeyCode == Enum.KeyCode.A then
                CONTROL.L = -speed
            elseif input.KeyCode == Enum.KeyCode.D then
                CONTROL.R = speed
            elseif QEfly and input.KeyCode == Enum.KeyCode.E then
                CONTROL.Q = speed * 2
            elseif QEfly and input.KeyCode == Enum.KeyCode.Q then
                CONTROL.E = -speed * 2
            end
        end
    end)

    flyKeyUp = UserInputService.InputEnded:Connect(function(input)
        if flying then
            if input.KeyCode == Enum.KeyCode.W then
                CONTROL.F = 0
            elseif input.KeyCode == Enum.KeyCode.S then
                CONTROL.B = 0
            elseif input.KeyCode == Enum.KeyCode.A then
                CONTROL.L = 0
            elseif input.KeyCode == Enum.KeyCode.D then
                CONTROL.R = 0
            elseif input.KeyCode == Enum.KeyCode.E then
                CONTROL.Q = 0
            elseif input.KeyCode == Enum.KeyCode.Q then
                CONTROL.E = 0
            end
        end
    end)
end

createToggleButton()
setupControls()
